---
layout:     post
title:      DPTP SOSR 2019
subtitle:   Time-synchronization in the Programmable Data Plane
date:       2019-4-22
author:     Yiran
header-img: img/post-bg-sea2.jpg
catalog: true
tags:
    - Programmable Switches
---

## [Precise Time-synchronization in the Data-Plane using Programmable Switching ASICs](https://www.comp.nus.edu.sg/~pravein/papers/DPTP_SOSR19.pdf)
### 核心思想 

在可编程交换机数据平面实现时间同步协议. ```亮点```：非常详尽的可编程交换机各部分delay的测量

### Motivation

- NTP精度不够（软件timestamp）
- PTP标准精度高，能够实现纳秒级别的同步（硬件timestamp），但是由于通常由**端主机软件或者交换机控制平面**实现，存在一些问题：（1）the client requires several synchronization rounds and statistical filtering to offset clock drifts suffered during software processing delays. This results in clients requiring up to 10 minutes to achieve an offset below 1 µs.（2）在高负载情况下精度下降至100微秒（3）软件实现不易扩展（性能下降），专有硬件设备部署开销大
- DTP(Datacenter Time Protocol) 利用物理层clock（Ethernet PHY layer）同步机制。(1) 非常依赖物理层特性：For 10 Gbps link speed, the PHY frequency is 156.25 MHz, and thus a single clock cycle is 6.4 ns. The synchronization precision achievable for 10G NIC is bounded by 25.6 ns (4 clock cycles) for a single hop. (2)全部物理层需要部署特殊硬件

**可编程交换机带来的机遇:**

   （1）灵活的数据包头处理; (2) 带状态存储;（3）自带ns级时钟, 使用42-48 bit counters保证能够几小时不回绕;

### Measurement and understanding

设计前的重要一步：需要理解 **参考时钟** 与 **请求的client**的通信中各部分的delay组成及变化。

```Achieving nanosecond-scale synchronization requires accounting for nanosecond-level variability in the various delay components```

模型：request-respond--- a **client** sends a request to synchronize with a **server** who maintains the reference clock

PISA:
<img width="450" height="450" src="/img/post-dptp-1.png"/>

- Switch to Switch 

   Switch to Switch delay breakdown:

   <img width="450" height="450" src="/img/post-dptp-2.png"/>

   $T_{ReqIg}$: Timestamp (Request packet arrival at ingress pipeline of SW1).

   **ReqQ**: Duration (Ingress pipeline processing and packet queuing at buffer engine).

   **ReqWD**: Duration (Wire-delay across DAC cable).

   **MacD**: Duration (Input buffering and parsing).

   其余可结合 Figure 2. 通过加timestamp, 论文进行了重复实验测量每个delay component.

   <img width="850" height="350" src="/img/post-dptp-3.png"/>

   ```重要结论:```

   (1) RespTx and RespQ to be the major contributors of the total delay; RespTx includes egress pipeline processing, deparsing, Tx MAC delay and serialization,其中 egress pipeline processing时间固定，变量来自于其他三个

   (2) Wire-delay具有不对称性：between request and response 并且asymmetry variation随着链路速率增加而降低（也就是链路速度越高时钟精度越高）

   (3) 尽管不同component的delay会变化, 但是它们中的大多数都是可测量的, 这种变化性不会影响时钟同步, 唯一unaccounted的是wire delay.

   (4) To accurately account for a packet’s exit timestamp, a follow-up packet is required. The follow-up packet could be avoided if the packet departure timestamp could precisely capture packet’s exit time and could be embedded in the data-plane.



- Switch to Host

   A request packet originates from a host (rack server) and a switch responds to the request. 使用了两种网卡。
   
   其中一种网卡：

   <img width="850" height="350" src="/img/post-dptp-4.png"/>

   **NicWireDelay**: consists of the two-way wire delay and the MAC/serialization delay incurred at the NIC/transceiver.

   
   ```重要结论:```

   (1) An unaccounted and variable : NicWireDelay.

   (2) The NicWireDelay varies up to 27 ns in Intel X710 (SFP+) and 16 ns in Intel XXV710 (SFP28) under idle conditions.

   (3) 当有主机的cross traffic存在时, NicWireDelay增加. 几乎随load线性增加. traffic packet 64bytes比 1500 bytes增加更快.

   (4) 时间同步在有主机的upstream cross traffic 存在时会产生错误，由于（asymmetry of NicWireDelay）. Hence, it is ideal for the host to have knowledge of the cross-traffic volume to minimize the error


### Design


### Implementation and evaluation


### My thinking
